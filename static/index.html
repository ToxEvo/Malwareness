<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malwareness</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Header section with navigation links and buttons for login and logout -->
    <header>
        <h1 data-value="MALWARENESS" class="logo">MALWARENESS</h1>
        <nav class="navigation">
            <a href="#" id="home-link">Home</a>
            <a href="#" id="practice-link" style="display: none;">Practice</a>
            <a href="#" id="analysis-link">Analysis</a>
            <a href="#" id="about-link">About</a>
            <button class="bLogin-popup" id="login-button">Login</button>
            <button class="bLogin-popup" id="logout-button" style="display: none;">Logout</button>
            <button class="bLogin-popup" id="username-display" style="display: none;"></button>
        </nav>
    </header>

    <!-- Login form popup -->
    <div class="wrapper" id="login-wrapper">
        <div class="formB-login">
            <h2>Login</h2>
            <form id="login-form">
                <div class="inputB">
                    <span class="icon"><ion-icon name="person-circle"></ion-icon></span>
                    <input type="text" id="login-username" required>
                    <label>Username</label>
                </div>
                <div class="inputB">
                    <span class="icon"><ion-icon name="lock-open"></ion-icon></span>
                    <input type="password" id="login-password" required>
                    <label>Password</label>
                </div>
                <button type="submit" class="button">Login</button>
                <div class="register"><p>Don't Have an Account? <a href="#" class="registerLink">Register</a></p></div>
            </form>
        </div>
    </div>

    <!-- Registration form popup -->
    <div class="wrapper" id="register-wrapper">
        <div class="formB-login">
            <h2>Register</h2>
            <form id="reg-form">
                <div class="inputB">
                    <span class="icon"><ion-icon name="person-circle"></ion-icon></span>
                    <input type="text" id="reg-username" required>
                    <label>Username</label>
                </div>
                <div class="inputB">
                    <span class="icon"><ion-icon name="lock-open"></ion-icon></span>
                    <input type="password" id="reg-password" required>
                    <label>Password</label>
                </div>
                <button type="submit" class="button">Register</button>
            </form>
        </div>
    </div>

    <!-- User information popup -->
    <div class="wrapper" id="user-info-wrapper">
        <div class="formB-login">
            <h2>User Info</h2>
            <div class="inputB">
                <label>Username: <span id="user-info-username"></span></label>
            </div>
            <div class="inputB">
                <label>Score: <span id="user-info-score"></span></label>
            </div>
            <div class="inputB">
                <label>Date of Account Creation: <span id="user-info-dateCreated"></span></label>
            </div>
            <button class="button" id="close-user-info">Close</button>
        </div>
    </div>

    <!-- Background text animations -->
    <div class="background-text">
        <div class="row" data-original="MALWARENESS SECURITY PROTECTION">
            <span>MALWARENESS</span>
            <span>SECURITY</span>
            <span>PROTECTION</span>
        </div>
        <div class="row" data-original="MALWARE VIRUS SAFETY">
            <span>MALWARE</span>
            <span>VIRUS</span>
            <span>SAFETY</span>
        </div>
        <div class="row" data-original="DEFENSE SECURE THREAT">
            <span>DEFENSE</span>
            <span>SECURE</span>
            <span>THREAT</span>
        </div>
        <div class="row" data-original="ANALYSIS PROTECTION SECURITY">
            <span>ANALYSIS</span>
            <span>PROTECTION</span>
            <span>SECURITY</span>
        </div>
        <div class="row" data-original="MALWARENESS SAFETY DEFENSE">
            <span>MALWARENESS</span>
            <span>SAFETY</span>
            <span>DEFENSE</span>
        </div>
    </div>

    <!-- About section -->
    <div id="about-text" class="hidden">
        <p>Malwareness Project demo by Dawid Orlikowski</p>
        <p>C3624738</p>
        <p>Leeds Beckett University Final Project</p>
    </div>

    <!-- Analysis section -->
    <div id="analysis-text" class="hidden">
        <p>Not available in project demo</p>
        <p>Feature currently in development</p>
    </div>

    <!-- Practice section -->
    <div id="practice-text" class="hidden">
        <h2>Task 1: Peek into Malwareness</h2>
        <p>Credit: 50 Points</p>
        <p>Inspect the source code of Malwareness via "Page Source" or any other applicable means and find the name of the function responsible for morphing of "Malwareness" when hovered. All of the source code is unobfuscated making it a rather trivial task.</p>
        <form id="task1-form">
            <label for="function-name">Function Name:</label>
            <input type="text" id="function-name" required>
            <button type="submit" class="button">Submit</button>
        </form>
        <p id="task1-message"></p>
    </div>

    <!-- Task 2 section -->
    <div id="task2-text" class="hidden">
        <h2>Task 2: To be revealed...</h2>
        <p>Details for Task 2 will be available after completing Task 1.</p>
    </div>

    <!-- JavaScript logic for handling form submissions, user interactions, and animations -->
    <script>
        // Registration form submission
        const regForm = document.getElementById('reg-form');
        regForm.addEventListener('submit', registerUser);

        async function registerUser(event) {
            event.preventDefault();
            const username = document.getElementById('reg-username').value;
            const password = document.getElementById('reg-password').value;

            const result = await fetch('/api/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username,
                    password
                })
            }).then((res) => res.json());

            if (result.status === 'ok') {
                alert('Success');
            } else {
                alert(result.error);
            }
        }

        // Login form submission
        const loginForm = document.getElementById('login-form');
        loginForm.addEventListener('submit', loginUser);

        async function loginUser(event) {
            event.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;

            const result = await fetch('/api/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username,
                    password
                })
            }).then((res) => res.json());

            if (result.status === 'ok') {
                console.log('Got the token: ', result.data);
                localStorage.setItem('token', result.data);
                displayUsername();
                alert('Success');
            } else {
                alert(result.error);
            }
        }

        // Display username after successful login
        async function displayUsername() {
            const token = localStorage.getItem('token');
            if (token) {
                const result = await fetch('/api/user', {
                    method: 'GET',
                    headers: {
                        'x-access-token': token
                    }
                }).then((res) => res.json());

                if (result.status === 'ok') {
                    const usernameDisplay = document.getElementById('username-display');
                    const loginButton = document.getElementById('login-button');
                    const logoutButton = document.getElementById('logout-button');
                    const practiceLink = document.getElementById('practice-link');
                    const analysisLink = document.getElementById('analysis-link');

                    usernameDisplay.innerText = result.username;
                    usernameDisplay.style.display = 'inline';
                    loginButton.style.display = 'none';
                    logoutButton.style.display = 'inline';
                    practiceLink.style.display = 'inline';
                    analysisLink.style.display = 'inline';

                    // Store additional user info in local storage
                    localStorage.setItem('username', result.username);
                    localStorage.setItem('score', result.score);
                    localStorage.setItem('dateCreated', result.dateCreated);
                }
            }
        }

        // Show user information
        async function showUserInfo() {
            const userInfoWrapper = document.getElementById('user-info-wrapper');
            const username = localStorage.getItem('username');
            const score = localStorage.getItem('score');
            const dateCreated = new Date(localStorage.getItem('dateCreated')).toLocaleDateString();

            document.getElementById('user-info-username').innerText = username;
            document.getElementById('user-info-score').innerText = score;
            document.getElementById('user-info-dateCreated').innerText = dateCreated;

            userInfoWrapper.style.display = 'flex';
            setTimeout(() => {
                userInfoWrapper.style.opacity = '1';
            }, 10);
        }

        // Close user information popup
        async function closeUserInfo() {
            const userInfoWrapper = document.getElementById('user-info-wrapper');
            userInfoWrapper.style.opacity = '0';
            setTimeout(() => {
                userInfoWrapper.style.display = 'none';
            }, 300);
        }

        // Logout user
        async function logoutUser() {
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            localStorage.removeItem('score');
            localStorage.removeItem('dateCreated');
            
            document.getElementById('username-display').style.display = 'none';
            document.getElementById('logout-button').style.display = 'none';
            document.getElementById('login-button').style.display = 'inline';
            document.getElementById('practice-link').style.display = 'none';
            document.getElementById('analysis-link').style.display = 'none';
            alert('Logged out successfully');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const loginButton = document.querySelector('.bLogin-popup');
            const registerLink = document.querySelector('.registerLink');
            const loginWrapper = document.getElementById('login-wrapper');
            const registerWrapper = document.getElementById('register-wrapper');
            const loginForm = loginWrapper.querySelector('.formB-login');
            const registerForm = registerWrapper.querySelector('.formB-login');
            const logoutButton = document.getElementById('logout-button');
            const usernameDisplay = document.getElementById('username-display');
            const homeLink = document.getElementById('home-link');
            const aboutLink = document.getElementById('about-link');
            const practiceLink = document.getElementById('practice-link');
            const analysisLink = document.getElementById('analysis-link');
            const backgroundText = document.querySelector('.background-text');
            const aboutText = document.getElementById('about-text');
            const analysisText = document.getElementById('analysis-text');
            const practiceText = document.getElementById('practice-text');
            const task1Form = document.getElementById('task1-form');
            const task2Text = document.getElementById('task2-text');
            const closeUserInfoButton = document.getElementById('close-user-info');

            loginButton.addEventListener('click', () => {
                loginWrapper.style.display = 'flex';
                setTimeout(() => {
                    loginWrapper.style.opacity = '1';
                }, 10);
            });

            registerLink.addEventListener('click', (event) => {
                event.preventDefault();
                loginWrapper.style.opacity = '0';
                setTimeout(() => {
                    loginWrapper.style.display = 'none';
                    registerWrapper.style.display = 'flex';
                    setTimeout(() => {
                        registerWrapper.style.opacity = '1';
                    }, 10);
                }, 300);
            });

            document.addEventListener('click', (event) => {
                if (!loginForm.contains(event.target) && !loginButton.contains(event.target)) {
                    loginWrapper.style.opacity = '0';
                    setTimeout(() => {
                        loginWrapper.style.display = 'none';
                    }, 300);
                }

                if (!registerForm.contains(event.target) && !registerLink.contains(event.target)) {
                    registerWrapper.style.opacity = '0';
                    setTimeout(() => {
                        registerWrapper.style.display = 'none';
                    }, 300);
                }
            });

            logoutButton.addEventListener('click', logoutUser);
            usernameDisplay.addEventListener('click', showUserInfo);
            closeUserInfoButton.addEventListener('click', closeUserInfo);

            homeLink.addEventListener('click', () => {
                aboutText.classList.remove('visible');
                analysisText.classList.remove('visible');
                practiceText.classList.remove('visible');
                task2Text.classList.remove('visible');
                setTimeout(() => {
                    aboutText.classList.add('hidden');
                    analysisText.classList.add('hidden');
                    practiceText.classList.add('hidden');
                    task2Text.classList.add('hidden');
                    backgroundText.classList.remove('hidden');
                    setTimeout(() => {
                        backgroundText.classList.remove('hidden-opacity');
                    }, 10);
                }, 1000);
            });

            practiceLink.addEventListener('click', () => {
                backgroundText.classList.add('hidden-opacity');
                aboutText.classList.remove('visible');
                analysisText.classList.remove('visible');
                setTimeout(() => {
                    backgroundText.classList.add('hidden');
                    aboutText.classList.add('hidden');
                    analysisText.classList.add('hidden');
                    practiceText.classList.remove('hidden');
                    setTimeout(() => {
                        practiceText.classList.add('visible');
                    }, 10);
                }, 1000);
            });

            analysisLink.addEventListener('click', () => {
                backgroundText.classList.add('hidden-opacity');
                aboutText.classList.remove('visible');
                practiceText.classList.remove('visible');
                setTimeout(() => {
                    backgroundText.classList.add('hidden');
                    aboutText.classList.add('hidden');
                    practiceText.classList.add('hidden');
                    analysisText.classList.remove('hidden');
                    setTimeout(() => {
                        analysisText.classList.add('visible');
                        setTimeout(() => {
                            analysisText.classList.add('morph-white');
                        }, 3000); // Add the morph-white class after 3 seconds
                    }, 10);
                }, 1000);
            });

            aboutLink.addEventListener('click', () => {
                backgroundText.classList.add('hidden-opacity');
                analysisText.classList.remove('visible');
                practiceText.classList.remove('visible');
                setTimeout(() => {
                    backgroundText.classList.add('hidden');
                    analysisText.classList.add('hidden');
                    practiceText.classList.add('hidden');
                    aboutText.classList.remove('hidden');
                    setTimeout(() => {
                        aboutText.classList.add('visible');
                        setTimeout(() => {
                            aboutText.classList.add('morph-white');
                        }, 3000); // Add the morph-white class after 3 seconds
                    }, 10);
                }, 1000);
            });

            displayUsername();

            // Event listener for task1 form submission
            task1Form.addEventListener('submit', async (event) => {
                event.preventDefault();
                const functionName = document.getElementById('function-name').value;
                if (functionName === 'morphText') {
                    await incrementUserScore(50);
                    document.getElementById('task1-message').textContent = 'Correct! Your score has been increased by 50 points.';
                    setTimeout(() => {
                        practiceText.classList.remove('visible');
                        setTimeout(() => {
                            practiceText.classList.add('hidden');
                            task2Text.classList.remove('hidden');
                            setTimeout(() => {
                                task2Text.classList.add('visible');
                            }, 10);
                        }, 1000);
                    }, 1000);
                } else {
                    document.getElementById('task1-message').textContent = 'Incorrect function name. Please try again.';
                }
            });
        });

        async function incrementUserScore(points) {
            const token = localStorage.getItem('token');
            const response = await fetch('/api/increment-score', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-access-token': token
                },
                body: JSON.stringify({ points })
            });
            const result = await response.json();
            if (result.status === 'ok') {
                const newScore = result.newScore;
                localStorage.setItem('score', newScore);
                document.getElementById('user-info-score').textContent = newScore;
            } else {
                alert('Failed to increment score: ' + result.error);
            }
        }

        // Function to morph text
        function morphText() {
            const rows = document.querySelectorAll('.background-text .row');
            const targetText = ["REVERSE", "TO", "PROGRESS"];
            rows.forEach((row, rowIndex) => {
                setTimeout(() => {
                    const spans = row.querySelectorAll('span');
                    if (rowIndex % 2 === 0) {
                        row.classList.add('morphing-black');
                    } else {
                        row.classList.remove('morphing-black');
                    }
                    spans.forEach((span, spanIndex) => {
                        const originalText = span.textContent;
                        span.dataset.original = originalText;
                        span.dataset.target = targetText[spanIndex % targetText.length];
                        morph(span);
                    });
                }, rowIndex * 1000); // Delay each row by 1 second
            });
        }

        // Function to revert text
        function revertText() {
            const rows = document.querySelectorAll('.background-text .row');
            rows.forEach((row, rowIndex) => {
                setTimeout(() => {
                    const spans = row.querySelectorAll('span');
                    row.classList.remove('morphing-black');
                    spans.forEach((span) => {
                        span.dataset.target = span.dataset.original;
                        morph(span);
                    });
                }, rowIndex * 1000); // Delay each row by 1 second
            });
        }

        // Function to handle the morphing effect
        function morph(span) {
            const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            let iterations = 0;
            const targetText = span.dataset.target;

            // Adjust the span's inner text length
            span.innerText = targetText.padEnd(span.innerText.length, " ");

            const interval = setInterval(() => {
                span.innerText = span.innerText.split("")
                    .map((letter, index) => {
                        if (index < iterations) {
                            return targetText[index] || " ";
                        }

                        return letters[Math.floor(Math.random() * 26)];
                    })
                    .join("");

                if (iterations >= targetText.length) {
                    clearInterval(interval);
                }

                iterations += 1 / 3;
            }, 30);
        }

        // Interval to morph and revert text every 10 seconds
        setInterval(() => {
            morphText();
            setTimeout(revertText, 4000); // Start reverting after 4 seconds (2s morph + 2s stay)
        }, 10000);

        // Logo hover effect
        const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";

        document.querySelector("h1").onmouseover = event => {
            let iterations = 0;

            const interval = setInterval(() => {
                event.target.innerText = event.target.innerText.split("")
                    .map((letter, index) => {
                        if (index < iterations) {
                            return event.target.dataset.value[index];
                        }

                        return letters[Math.floor(Math.random() * 26)];
                    })
                    .join("");

                if (iterations >= event.target.dataset.value.length) {
                    clearInterval(interval);
                }

                iterations += 1 / 3;
            }, 30);
        };
    </script>

    <!-- Importing Ionicons for icons used in forms -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
</body>
</html>