<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Malwareness</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <header>
        <h1 data-value="MALWARENESS" class="logo">MALWARENESS</h1>
        <nav class="navigation">
            <a href="#">Home</a>
            <a href="#">Practice</a>
            <a href="#">Analysis</a>
            <a href="#">About</a>
            <button class="bLogin-popup" id="login-button">Login</button>
            <button class="bLogin-popup" id="logout-button" style="display: none;">Logout</button>
            <button class="bLogin-popup" id="username-display" style="display: none;"></button>
        </nav>
    </header>

    <div class="wrapper" id="login-wrapper">
        <div class="formB-login">
            <h2>Login</h2>
            <form id="login-form">
                <div class="inputB">
                    <span class="icon"><ion-icon name="person-circle"></ion-icon></span>
                    <input type="text" id="login-username" required>
                    <label>Username</label>
                </div>
                <div class="inputB">
                    <span class="icon"><ion-icon name="lock-open"></ion-icon></span>
                    <input type="password" id="login-password" required>
                    <label>Password</label>
                </div>
                <div class="remember">
                    <label><input type="checkbox">Remember Me</label>
                    <a href="#">Forgot Password?</a>
                </div>
                <button type="submit" class="button">Login</button>
                <div class="register"><p>Don't Have an Account? <a href="#" class="registerLink">Register</a></p></div>
            </form>
        </div>
    </div>

    <div class="wrapper" id="register-wrapper">
        <div class="formB-login">
            <h2>Register</h2>
            <form id="reg-form">
                <div class="inputB">
                    <span class="icon"><ion-icon name="person-circle"></ion-icon></span>
                    <input type="text" id="reg-username" required>
                    <label>Username</label>
                </div>
                <div class="inputB">
                    <span class="icon"><ion-icon name="lock-open"></ion-icon></span>
                    <input type="password" id="reg-password" required>
                    <label>Password</label>
                </div>
                <button type="submit" class="button">Register</button>
            </form>
        </div>
    </div>

    <script>
        const regForm = document.getElementById('reg-form');
        regForm.addEventListener('submit', registerUser);

        async function registerUser(event) {
            event.preventDefault();
            const username = document.getElementById('reg-username').value;
            const password = document.getElementById('reg-password').value;

            const result = await fetch('/api/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username,
                    password
                })
            }).then((res) => res.json());

            if (result.status === 'ok') {
                alert('Success');
            } else {
                alert(result.error);
            }
        }

        const loginForm = document.getElementById('login-form');
        loginForm.addEventListener('submit', loginUser);

        async function loginUser(event) {
            event.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;

            const result = await fetch('/api/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username,
                    password
                })
            }).then((res) => res.json());

            if (result.status === 'ok') {
                console.log('Got the token: ', result.data);
                localStorage.setItem('token', result.data);
                displayUsername();
                alert('Success');
            } else {
                alert(result.error);
            }
        }

        async function displayUsername() {
            const token = localStorage.getItem('token');
            if (token) {
                const result = await fetch('/api/user', {
                    method: 'GET',
                    headers: {
                        'x-access-token': token
                    }
                }).then((res) => res.json());

                if (result.status === 'ok') {
                    const usernameDisplay = document.getElementById('username-display');
                    const loginButton = document.getElementById('login-button');
                    const logoutButton = document.getElementById('logout-button');

                    usernameDisplay.innerText = result.username;
                    usernameDisplay.style.display = 'inline';
                    loginButton.style.display = 'none';
                    logoutButton.style.display = 'inline';
                }
            }
        }

        async function logoutUser() {
            localStorage.removeItem('token');
            const usernameDisplay = document.getElementById('username-display');
            const loginButton = document.getElementById('login-button');
            const logoutButton = document.getElementById('logout-button');

            usernameDisplay.style.display = 'none';
            loginButton.style.display = 'inline';
            logoutButton.style.display = 'none';

            await fetch('/api/logout', {
                method: 'POST',
            });

            alert('Logged out successfully');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const loginButton = document.querySelector('.bLogin-popup');
            const registerLink = document.querySelector('.registerLink');
            const loginWrapper = document.getElementById('login-wrapper');
            const registerWrapper = document.getElementById('register-wrapper');
            const loginForm = loginWrapper.querySelector('.formB-login');
            const registerForm = registerWrapper.querySelector('.formB-login');
            const logoutButton = document.getElementById('logout-button');
            const usernameDisplay = document.getElementById('username-display');

            loginButton.addEventListener('click', () => {
                loginWrapper.style.display = 'flex';
                setTimeout(() => {
                    loginWrapper.style.opacity = '1';
                }, 10);
            });

            registerLink.addEventListener('click', (event) => {
                event.preventDefault();
                loginWrapper.style.opacity = '0';
                setTimeout(() => {
                    loginWrapper.style.display = 'none';
                    registerWrapper.style.display = 'flex';
                    setTimeout(() => {
                        registerWrapper.style.opacity = '1';
                    }, 10);
                }, 300);
            });

            document.addEventListener('click', (event) => {
                if (!loginForm.contains(event.target) && !loginButton.contains(event.target)) {
                    loginWrapper.style.opacity = '0';
                    setTimeout(() => {
                        loginWrapper.style.display = 'none';
                    }, 300);
                }

                if (!registerForm.contains(event.target) && !registerLink.contains(event.target)) {
                    registerWrapper.style.opacity = '0';
                    setTimeout(() => {
                        registerWrapper.style.display = 'none';
                    }, 300);
                }
            });

            logoutButton.addEventListener('click', logoutUser);
            usernameDisplay.addEventListener('click', logoutUser);

            displayUsername();
        });
    </script>

    <script src="logo.js"></script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
</body>
</html>